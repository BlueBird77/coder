<FirstLogonCommands>
	<SynchronousCommand>
		<CommandLine>cmd /c "copy C:\AzureData\CustomData.bin C:\AzureData\CoderAgent.ps1"</CommandLine>
		<Description>Move the CustomData file to the working directory</Description>
		<Order>10</Order>
	</SynchronousCommand>
	<!-- I cannot get this second SynchronousCommand to run or find the failure logs.
	However, when I login via RDP and enter it manually, it runs fine -->
	<SynchronousCommand>
		<CommandLine>powershell.exe -ExecutionPolicy Unrestricted -Command {
    $TaskName = 'MyStartupScript'
    $Action = New-ScheduledTaskAction -Execute 'powershell.exe' -Argument '-sta -ExecutionPolicy Unrestricted -Command "C:\AzureData\CoderAgent.ps1 ^| Out-File C:\AzureData\CoderAgent.log"'
    $TriggerAtStartup = New-ScheduledTaskTrigger -AtStartup
    $TriggerDelay = New-ScheduledTaskTrigger -Once -At (Get-Date).AddSeconds(15)
    $Settings = New-ScheduledTaskSettingsSet -DontStopOnIdleEnd -ExecutionTimeLimit ([TimeSpan]::FromDays(3650)) -Compatibility Win8
    $Principal = New-ScheduledTaskPrincipal -UserId "$env:USERDOMAIN\$env:USERNAME" -RunLevel Highest -LogonType S4U
    Register-ScheduledTask -TaskName $TaskName -Action $Action -Trigger $TriggerAtStartup, $TriggerDelay -Settings $Settings -Principal $Principal -Force
 }
</CommandLine>
		<Description>Register the scheduled task</Description>
		<Order>20</Order>
	</SynchronousCommand>
</FirstLogonCommands>
